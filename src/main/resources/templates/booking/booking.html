<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>항공권 예약 | Asiana Clone</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <script>
        let selectedFirst = null;
        let selectedSecond = null;

        function toggleTripType(type) {
            document.getElementById('tripType').value = type;

            const roundBtn = document.getElementById('roundTab');
            const oneBtn = document.getElementById('onewayTab');
            const secondJourneyGroup = document.getElementById('secondJourneyGroup');

            if (type === 'ROUND') {
                roundBtn.classList.add('btn-primary');
                roundBtn.classList.remove('btn-outline-primary');

                oneBtn.classList.add('btn-outline-primary');
                oneBtn.classList.remove('btn-primary');

                secondJourneyGroup.style.display = 'block';
            } else {
                oneBtn.classList.add('btn-primary');
                oneBtn.classList.remove('btn-outline-primary');

                roundBtn.classList.add('btn-outline-primary');
                roundBtn.classList.remove('btn-primary');

                secondJourneyGroup.style.display = 'none';
                selectedSecond = null;
            }
        }

        function selectJourney(type, btn) {
            if(type === 'FIRST') {
                selectedFirst = btn.dataset.flightnumber;
                document.querySelectorAll('.first-journey button').forEach(b => b.classList.remove('btn-primary'));
                btn.classList.add('btn-primary');
            } else if(type === 'SECOND') {
                selectedSecond = btn.dataset.flightnumber;
                document.querySelectorAll('.second-journey button').forEach(b => b.classList.remove('btn-primary'));
                btn.classList.add('btn-primary');
            }
        }

        function goToPayment() {
            const tripType = document.getElementById('tripType').value;

            if(!selectedFirst) {
                alert('첫 번째 여정을 선택해주세요.');
                return;
            }

            if(tripType === 'ROUND' && !selectedSecond) {
                alert('두 번째 여정을 선택해주세요.');
                return;
            }

            const form = document.createElement('form');
            form.method = 'post';
            form.action = 'booking/payment';

            const firstInput = document.createElement('input');
            firstInput.type = 'hidden';
            firstInput.name = 'firstJourney';
            firstInput.value = selectedFirst;
            form.appendChild(firstInput);

            if(tripType === 'ROUND') {
                const secondInput = document.createElement('input');
                secondInput.type = 'hidden';
                secondInput.name = 'secondJourney';
                secondInput.value = selectedSecond;
                form.appendChild(secondInput);
            }

            const typeInput = document.createElement('input');
            typeInput.type = 'hidden';
            typeInput.name = 'tripType';
            typeInput.value = tripType;
            form.appendChild(typeInput);

            document.body.appendChild(form);
            form.submit();
        }

        window.onload = () => {
            const tripType = document.getElementById('tripType').value || 'ROUND';
            toggleTripType(tripType);
        };
    </script>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<section class="container py-5">
    <h2 class="fw-bold mb-4 text-center">항공권 예약</h2>

    <!-- 왕복/편도 탭 -->
    <div class="d-flex justify-content-center mb-4">
        <div class="btn-group" role="group">
            <button id="roundTab" type="button"
                    class="btn btn-outline-primary"
                    onclick="toggleTripType('ROUND')">왕복</button>
            <button id="onewayTab" type="button"
                    class="btn btn-outline-primary"
                    onclick="toggleTripType('ONEWAY')">편도</button>
        </div>
    </div>

    <!-- 예약 폼 -->
    <form class="border p-4 rounded shadow-sm col-md-8 mx-auto" th:action="@{/booking}" method="post">
        <input type="hidden" name="tripType" id="tripType" th:value="${search != null ? search.tripType : 'ROUND'}">

        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">출발지</label>
                <input type="text" name="departureAirport" class="form-control" placeholder="예: 서울"
                       th:value="${search != null ? search.departureAirport : ''}">
            </div>
            <div class="col-md-6">
                <label class="form-label">도착지</label>
                <input type="text" name="arrivalAirport" class="form-control" placeholder="예: 도쿄"
                       th:value="${search != null ? search.arrivalAirport : ''}">
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">첫 번째 여정</label>
                <input type="date" name="departureDate" class="form-control"
                       th:value="${search != null ? search.departureDate : ''}">
            </div>
            <div class="col-md-6" id="secondJourneyGroup">
                <label class="form-label">두 번째 여정</label>
                <input type="date" name="returnDate" class="form-control"
                       th:value="${search != null ? search.returnDate : ''}">
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label">성인</label>
                <input type="number" name="adult" class="form-control" min="0"
                       th:value="${search != null ? search.adult : 1}">
            </div>
            <div class="col-md-4">
                <label class="form-label">소아</label>
                <input type="number" name="child" class="form-control" min="0"
                       th:value="${search != null ? search.child : 0}">
            </div>
            <div class="col-md-4">
                <label class="form-label">유아</label>
                <input type="number" name="infant" class="form-control" min="0"
                       th:value="${search != null ? search.infant : 0}">
            </div>
        </div>

        <div class="row mb-3">
            <label class="form-label col-12">좌석 등급</label>
            <div class="col-md-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="seatEconomyDiscount" name="seatClass" value="ECONOMY_DISCOUNT"
                           th:checked="${search != null and search.seatClass != null and #lists.contains(search.seatClass, 'ECONOMY_DISCOUNT')}">
                    <label class="form-check-label" for="seatEconomyDiscount">이코노미 특가</label>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="seatEconomy" name="seatClass" value="ECONOMY"
                           th:checked="${search != null and search.seatClass != null and #lists.contains(search.seatClass, 'ECONOMY')}">
                    <label class="form-check-label" for="seatEconomy">이코노미</label>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="seatBusiness" name="seatClass" value="BUSINESS"
                           th:checked="${search != null and search.seatClass != null and #lists.contains(search.seatClass, 'BUSINESS')}">
                    <label class="form-check-label" for="seatBusiness">비즈니스</label>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="seatFirst" name="seatClass" value="FIRST"
                           th:checked="${search != null and search.seatClass != null and #lists.contains(search.seatClass, 'FIRST')}">
                    <label class="form-check-label" for="seatFirst">퍼스트</label>
                </div>
            </div>
        </div>

        <button class="btn btn-primary w-100 mt-3">항공편 조회</button>
    </form>

    <div class="mt-5">
        <!-- 첫 번째 여정 -->
        <div th:if="${outboundFlights != null}">
            <h4 class="fw-bold mb-3" th:if="${#lists.isEmpty(outboundFlights) == false}">첫 번째 여정</h4>

            <div class="table-responsive mb-5" th:if="${#lists.isEmpty(outboundFlights) == false}">
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th>항공편</th>
                        <th>출발</th>
                        <th>도착</th>
                        <th>출발 시간</th>
                        <th>도착 시간</th>
                        <th>운임</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="f : ${outboundFlights}" class="first-journey">
                        <td th:text="${f.flightNumber}"></td>
                        <td th:text="${f.departureAirport}"></td>
                        <td th:text="${f.arrivalAirport}"></td>
                        <td th:text="${f.departureTime}"></td>
                        <td th:text="${f.arrivalTime}"></td>
                        <td th:text="${f.price}"></td>
                        <td>
                            <button type="button" class="btn btn-outline-primary btn-sm"
                                    th:attr="data-flightNumber=${f.flightNumber}"
                                    onclick="selectJourney('FIRST', this)">
                                선택
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div th:if="${#lists.isEmpty(outboundFlights)}" class="alert alert-warning">
                첫 번째 여정 항공편이 없습니다.
            </div>
        </div>

        <!-- 두 번째 여정 -->
        <div th:if="${returnFlights != null}">
            <h4 class="fw-bold mb-3" th:if="${#lists.isEmpty(returnFlights) == false}">두 번째 여정</h4>

            <div class="table-responsive mb-5" th:if="${#lists.isEmpty(returnFlights) == false}">
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th>항공편</th>
                        <th>출발</th>
                        <th>도착</th>
                        <th>출발 시간</th>
                        <th>도착 시간</th>
                        <th>운임</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="f : ${returnFlights}" class="second-journey">
                        <td th:text="${f.flightNumber}"></td>
                        <td th:text="${f.departureAirport}"></td>
                        <td th:text="${f.arrivalAirport}"></td>
                        <td th:text="${f.departureTime}"></td>
                        <td th:text="${f.arrivalTime}"></td>
                        <td th:text="${f.price}"></td>
                        <td>
                            <button type="button" class="btn btn-outline-primary btn-sm"
                                    th:attr="data-flightNumber=${f.flightNumber}"
                                    onclick="selectJourney('SECOND', this)">
                                선택
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div th:if="${#lists.isEmpty(returnFlights)}" class="alert alert-warning">
                두 번째 여정 항공편이 없습니다.
            </div>
        </div>

        <!-- 결제 버튼 -->
        <div class="text-center mt-4"
             th:if="${outboundFlights != null and #lists.isEmpty(outboundFlights) == false}">
            <button type="button" class="btn btn-success px-5" onclick="goToPayment()">결제하기</button>
        </div>
    </div>

</section>

<div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>
